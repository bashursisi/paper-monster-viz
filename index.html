<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Paper Monster - Production Viz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { touch-action: manipulation; }
        canvas {
            background-color: #f1f5f9;
            display: block;
            margin: 0 auto;
            border-radius: 4px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            max-width: 100%;
        }
        /* Custom scrollbar for better mobile feel */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="bg-slate-200 h-screen flex flex-col font-sans text-slate-800 overflow-hidden">

    <!-- Header -->
    <div class="bg-slate-900 text-white p-3 shadow-md flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-amber-500 text-slate-900 font-black px-2 py-1 rounded text-xs tracking-widest">PROD TOOL</div>
            <h1 class="font-bold text-lg tracking-tight hidden sm:block">Visualizer v10</h1>
            <h1 class="font-bold text-md tracking-tight sm:hidden">Viz v10</h1>
        </div>
        <div class="text-xs text-slate-400 flex items-center gap-2">
            <span id="progressCount" class="font-mono text-green-400 font-bold">0/27 Done</span>
        </div>
    </div>

    <div class="flex-grow flex flex-col lg:flex-row gap-4 p-2 sm:p-4 max-h-[calc(100vh-60px)]">
        
        <!-- Left Sidebar (Controls) -->
        <div class="w-full lg:w-1/3 flex flex-col gap-2 sm:gap-3 h-auto lg:h-full shrink-0">
            <div class="bg-white p-3 sm:p-4 rounded-lg shadow-sm border border-slate-300">
                
                <!-- Shot Selector -->
                <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Jump to Shot</label>
                <select id="shotSelector" onchange="jumpToShot(this.value)" class="w-full mb-3 p-2 text-sm border-2 border-slate-200 rounded bg-slate-50 text-slate-700 font-semibold focus:outline-none focus:border-amber-500 transition-colors">
                    <!-- Options populated by JS -->
                </select>

                <!-- Navigation Buttons -->
                <div class="flex items-center justify-between mb-3">
                    <button onclick="changeShot(-1)" class="px-4 py-3 bg-slate-100 active:bg-slate-300 rounded-lg text-slate-700 font-bold transition touch-manipulation flex-1 mr-2">◀ Prev</button>
                    
                    <div class="text-center w-24">
                        <span class="block text-[10px] text-slate-400 uppercase tracking-widest font-bold">SHOT</span>
                        <span id="shotCode" class="block text-3xl font-black text-amber-600 leading-none transition-colors duration-300">1.1</span>
                    </div>

                    <button onclick="changeShot(1)" class="px-4 py-3 bg-slate-800 active:bg-slate-600 rounded-lg text-white font-bold transition touch-manipulation flex-1 ml-2">Next ▶</button>
                </div>

                <!-- NEW: Done Button -->
                <button id="markDoneBtn" onclick="toggleDone()" class="w-full py-3 rounded-lg font-bold border-2 transition-all duration-200 flex items-center justify-center gap-2 touch-manipulation border-slate-300 text-slate-400 bg-white">
                    <span id="btnIcon" class="text-lg">⬜</span> <span id="btnText">Mark as Done</span>
                </button>
            </div>

            <!-- Info Box -->
            <div class="bg-white rounded-lg shadow-sm border border-slate-300 flex-grow overflow-y-auto flex flex-col min-h-[150px]">
                <div class="p-3 sm:p-4 border-b border-slate-100 bg-slate-50">
                    <h2 id="shotTitle" class="font-bold text-base sm:text-lg text-slate-800">Title</h2>
                    <div class="flex gap-2 mt-1">
                        <span id="shotLens" class="px-2 py-0.5 bg-blue-100 text-blue-800 text-[10px] font-bold uppercase rounded">Lens</span>
                        <span id="shotType" class="px-2 py-0.5 bg-purple-100 text-purple-800 text-[10px] font-bold uppercase rounded">Type</span>
                    </div>
                </div>
                <div class="p-3 sm:p-4 space-y-3">
                    <div>
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Action</h4>
                        <p id="shotAction" class="text-sm font-medium text-slate-700 leading-snug">Action text...</p>
                    </div>
                    <div id="dialogueBox" class="bg-amber-50 p-3 rounded-l-xl rounded-tr-xl border border-amber-100">
                        <h4 class="text-[10px] font-bold text-amber-600 uppercase tracking-wider mb-1">Dialogue</h4>
                        <p id="shotDialogue" class="text-sm italic text-amber-900 leading-snug">"Dialogue..."</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel (Canvas) -->
        <div class="w-full lg:w-2/3 bg-white p-1 rounded-lg shadow-sm border border-slate-300 flex flex-col grow h-full overflow-hidden relative">
            <div id="touchZone" class="relative flex-grow bg-slate-50 overflow-hidden flex items-center justify-center rounded w-full h-full">
                <canvas id="stageCanvas" width="800" height="600" class="object-contain w-full h-full"></canvas>
                
                <!-- Map Key Overlay -->
                <div class="absolute top-2 right-2 bg-white/90 p-2 rounded border border-slate-200 text-[9px] sm:text-[10px] shadow-sm pointer-events-none">
                    <div class="font-bold mb-1 text-slate-500 uppercase">Key</div>
                    <div class="grid grid-cols-2 gap-x-2 gap-y-1">
                        <div class="flex items-center"><span class="w-2 h-2 bg-blue-300 rounded-full mr-1"></span> Window</div>
                        <div class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span> Door</div>
                        <div class="flex items-center"><span class="w-2 h-2 bg-purple-500 rounded-full mr-1"></span> Teacher</div>
                        <div class="flex items-center"><span class="w-2 h-2 bg-gray-600 rounded-full mr-1"></span> Board</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- COMPLETE SHOT DATA (1.1 - 3.27) ---
        const shots = [
            // SCENE 1
            { code: "1.1", title: "Wide - Establish", lens: "Wide", type: "Static", action: "Establish quiet classroom. Camera at Door.", dialogue: "(SFX: LOUD Ticking Clock)", cam: {x:400, y:550, angle:315, fov:90}, layoutState: "sitting_all" },
            { code: "1.2", title: "ECU - Clock", lens: "Macro", type: "Hard Cut", action: "Second hand ticks 2 times.", dialogue: "(SFX: Tick... Tick...)", cam: {x:650, y:250, angle:0, fov:20}, layoutState: "sitting_all" },
            { code: "1.3", title: "Low Angle POV", lens: "Wide", type: "Floor Cam", action: "POV from floor (near Desk) looking up.", dialogue: "(Silence)", cam: {x:650, y:150, angle:270, fov:90}, layoutState: "sitting_all" },
            { code: "1.4", title: "Medium - Siyajîn", lens: "Standard", type: "Static", action: "Siyajîn leans back annoyed.", dialogue: "'Oh no. A substitute teacher is coming...'", cam: {x:500, y:400, angle:180, fov:40}, highlight: 'siyajin', layoutState: "sitting_all" },
            { code: "1.5", title: "Crash Zoom - Bejna", lens: "Zoom", type: "Kinetic Lunge", action: "LUNGE to Bejna. She stands.", dialogue: "'Our teacher is never late...'", cam: {x:550, y:300, angle:180, fov:50}, move: {startX:550, startY:300, endX:450, endY:300}, highlight: 'bejna', layoutState: "bejna_stands" },
            { code: "1.6", title: "Whip Pan Sequence", lens: "Wide", type: "Whip Pan", action: "Pan: Empty Desk -> Bagless Chair.", dialogue: "'No bag. No phone.'", cam: {x:600, y:150, angle:315, fov:70}, move: {type:'pan', angles:[270, 360]}, layoutState: "bejna_stands" },
            { code: "1.7", title: "Medium - Rênas", lens: "Standard", type: "Static", action: "Rênas reads calmly.", dialogue: "'Maybe she is with the principal...'", cam: {x:500, y:200, angle:180, fov:40}, highlight: 'renas', layoutState: "bejna_stands" },
            { code: "1.8", title: "Close Up - Rizgar", lens: "Long", type: "Cut on Action", action: "Rizgar biting nails.", dialogue: "'I am very nervous!'", cam: {x:450, y:180, angle:180, fov:30}, highlight: 'rizgar', layoutState: "bejna_stands" },
            
            // SCENE 2
            { code: "2.9", title: "Medium - Bejna", lens: "Standard", type: "Hero Shot", action: "Bejna takes charge.", dialogue: "'Okay team. Be quiet...'", cam: {x:500, y:300, angle:180, fov:50}, highlight: 'bejna', layoutState: "bejna_stands" },
            { code: "2.10", title: "Low Angle - Siyajîn", lens: "Wide", type: "Kinetic", action: "Siyajîn JUMPS onto chair!", dialogue: "'She is the big winner...'", cam: {x:400, y:500, angle:0, fov:75}, highlight: 'siyajin', layoutState: "siyajin_jumps" },
            { code: "2.11", title: "Two Shot", lens: "Standard", type: "Static", action: "Rênas & Siyajîn. Rênas sighs.", dialogue: "'No, that’s not possible.'", cam: {x:480, y:300, angle:180, fov:60}, highlight: 'renas', layoutState: "bejna_stands" },
            { code: "2.12", title: "OTS - Huddle", lens: "Standard", type: "OTS", action: "Group leans in fast.", dialogue: "'No, it's a secret...'", cam: {x:350, y:300, angle:0, fov:45}, highlight: 'asmin', layoutState: "group_huddle" },
            { code: "2.13", title: "Close Up - Dara", lens: "Long", type: "Static", action: "Dara looks around suspiciously.", dialogue: "'Maybe she is invisible!'", cam: {x:450, y:420, angle:180, fov:30}, highlight: 'dara', layoutState: "group_huddle" },
            { code: "2.14", title: "Lock-Off (VFX)", lens: "Standard", type: "Locked", action: "Marker writes 'HELLO' on board.", dialogue: "(SFX: Squeak)", cam: {x:600, y:300, angle:0, fov:50}, highlight: 'board', layoutState: "sitting_all" },
            { code: "2.15", title: "Crash Zoom - Dara", lens: "Zoom", type: "Kinetic", action: "Zoom on Dara pointing!", dialogue: "'Look! The marker!'", cam: {x:450, y:420, angle:180, fov:40}, move: {startX:450, startY:420, endX:350, endY:420}, highlight: 'dara', layoutState: "sitting_all" },
            { code: "2.16", title: "Wide - The Scare", lens: "Wide", type: "Action", action: "All students jump back!", dialogue: "'AAAAHH!!'", cam: {x:400, y:300, angle:0, fov:80}, layoutState: "scare_jump" },
            { code: "2.17", title: "ECU - Rizgar", lens: "Macro", type: "Static", action: "Rizgar shaking.", dialogue: "'A ghost?!'", cam: {x:300, y:180, angle:180, fov:25}, highlight: 'rizgar', layoutState: "scare_jump" },
            { code: "2.18", title: "Medium - Rênas", lens: "Standard", type: "Static", action: "Rênas rolls eyes.", dialogue: "'Just the wind...'", cam: {x:350, y:180, angle:180, fov:40}, highlight: 'renas', layoutState: "sitting_all" },
            { code: "2.19", title: "Tracking - Bejna", lens: "Wide", type: "Tracking", action: "Bejna pacing. Handheld.", dialogue: "'I think she is... captured!'", cam: {x:500, y:300, angle:180, fov:60}, move: {type:'pan', angles:[160, 200]}, highlight: 'bejna', layoutState: "bejna_pacing" },
            { code: "2.20", title: "Whip Pan - Spy", lens: "Wide", type: "Whip Pan", action: "Siyajîn Spy Pose. Whip Right.", dialogue: "'By spies!'", cam: {x:450, y:420, angle:180, fov:50}, highlight: 'siyajin', layoutState: "sitting_all" },
            
            // INSERTS
            { code: "2.20A", title: "POV - Hallway", lens: "Wide", type: "Shaky", action: "Running down hallway.", dialogue: "(SFX: Footsteps)", cam: {x:400, y:650, angle:90, fov:80}, layoutState: "sitting_all" },
            { code: "2.20B", title: "Low - Spies", lens: "Wide", type: "Low Angle", action: "Two spies blocking way.", dialogue: "(Music Sting)", cam: {x:400, y:680, angle:270, fov:70}, layoutState: "sitting_all" },
            { code: "2.20C", title: "Dutch Angle", lens: "Standard", type: "Tilted", action: "Siyajîn into watch.", dialogue: "'Eagle is captured.'", cam: {x:450, y:420, angle:160, fov:40}, highlight: 'siyajin', layoutState: "sitting_all" },
            
            // BACK TO ROOM
            { code: "2.21", title: "Close Up - Asmîn", lens: "Long", type: "Static", action: "Asmîn points to corner.", dialogue: "'It is the school monster.'", cam: {x:400, y:300, angle:180, fov:35}, highlight: 'asmin', layoutState: "sitting_all" },
            { code: "2.22", title: "Medium - Asmîn", lens: "Standard", type: "Crash Zoom", action: "Claw hands. Zoom on 'Hungry'.", dialogue: "'It is very hungry.'", cam: {x:400, y:300, angle:180, fov:45}, move: {startX:400, startY:300, endX:320, endY:300}, highlight: 'asmin', layoutState: "sitting_all" },
            
            // CLOSET
            { code: "2.22A", title: "POV - Flashlight", lens: "Wide", type: "POV", action: "Dark room. Searching.", dialogue: "(Breathing)", cam: {x:100, y:500, angle:45, fov:60}, layoutState: "sitting_all" },
            { code: "2.22B", title: "Reveal - Monster", lens: "Standard", type: "Jump Scare", action: "Light lands on Mop.", dialogue: "(JUMP SCARE SOUND)", cam: {x:120, y:520, angle:45, fov:50}, layoutState: "sitting_all" },
            
            // ENDING
            { code: "2.23", title: "Low Angle - Bejna", lens: "Wide", type: "Hero", action: "Bejna points to door.", dialogue: "'Let's go!'", cam: {x:500, y:300, angle:180, fov:60}, highlight: 'bejna', layoutState: "bejna_stands" },
            { code: "2.24", title: "High Angle - Rizgar", lens: "Wide", type: "High Angle", action: "Rizgar hides under desk.", dialogue: "'I am too small!'", cam: {x:280, y:180, angle:0, fov:70}, highlight: 'rizgar', layoutState: "rizgar_hiding" },
            
            // SCENE 3
            { code: "3.25", title: "Doorway Silhouette", lens: "Wide", type: "Low Angle", action: "Teacher enters door.", dialogue: "'The photocopy machine...'", cam: {x:400, y:550, angle:90, fov:80}, layoutState: "teacher_enter" },
            { code: "3.26", title: "Group Shot", lens: "Wide", type: "Static", action: "Students slump shoulders.", dialogue: "'A paper monster?'", cam: {x:600, y:300, angle:180, fov:70}, layoutState: "group_slump" },
            { code: "3.27", title: "Slow Zoom - Rênas", lens: "Standard", type: "Zoom", action: "Fourth Wall Break.", dialogue: "'See? I am always right.'", cam: {x:500, y:200, angle:180, fov:40}, move: {startX:500, startY:200, endX:450, endY:200}, highlight: 'renas', layoutState: "sitting_all" }
        ];

        let currentIndex = 0;
        let doneShots = JSON.parse(localStorage.getItem('paperMonster_doneShots')) || {}; // Persistent storage

        const canvas = document.getElementById('stageCanvas');
        const ctx = canvas.getContext('2d');
        const btnDone = document.getElementById('markDoneBtn');
        const btnText = document.getElementById('btnText');
        const btnIcon = document.getElementById('btnIcon');
        const shotCodeDisplay = document.getElementById('shotCode');
        const progressDisplay = document.getElementById('progressCount');

        // Layout Constants
        const DOOR_X = 400, DOOR_Y = 580;
        const BOARD_X = 760;
        
        // Students: Facing Right
        const seats = {
            renas:   {x: 400, y: 180, name: "Rênas"},
            rizgar:  {x: 280, y: 180, name: "Rizgar"},
            bejna:   {x: 400, y: 300, name: "Bejna"},
            asmin:   {x: 280, y: 300, name: "Asmîn"},
            siyajin: {x: 400, y: 420, name: "Siyajîn"},
            dara:    {x: 280, y: 420, name: "Dara"}
        };

        // --- INIT SELECTOR & STATUS ---
        function updateSelectorAndStatus() {
            const selector = document.getElementById('shotSelector');
            selector.innerHTML = ''; // Clear existing
            
            let doneCount = 0;

            shots.forEach((s, index) => {
                const isDone = doneShots[s.code];
                if (isDone) doneCount++;

                const opt = document.createElement('option');
                opt.value = index;
                // Add checkmark if done
                opt.text = `${isDone ? '✓ ' : ''}${s.code} - ${s.title}`;
                if (index === currentIndex) opt.selected = true;
                selector.add(opt);
            });

            // Update Progress Header
            progressDisplay.innerText = `${doneCount}/${shots.length} Done`;

            // Update Button & Main Display based on current shot
            const currentCode = shots[currentIndex].code;
            if (doneShots[currentCode]) {
                // Done State
                btnDone.className = "w-full py-3 rounded-lg font-bold border-2 transition-all duration-200 flex items-center justify-center gap-2 touch-manipulation border-green-600 bg-green-500 text-white shadow-md";
                btnText.innerText = "Completed";
                btnIcon.innerText = "✅";
                shotCodeDisplay.classList.add('text-green-600');
                shotCodeDisplay.classList.remove('text-amber-600');
            } else {
                // To Do State
                btnDone.className = "w-full py-3 rounded-lg font-bold border-2 transition-all duration-200 flex items-center justify-center gap-2 touch-manipulation border-slate-300 text-slate-400 bg-white hover:bg-slate-50";
                btnText.innerText = "Mark as Done";
                btnIcon.innerText = "⬜";
                shotCodeDisplay.classList.add('text-amber-600');
                shotCodeDisplay.classList.remove('text-green-600');
            }
        }

        function toggleDone() {
            const s = shots[currentIndex];
            if (doneShots[s.code]) {
                delete doneShots[s.code]; // Undo
            } else {
                doneShots[s.code] = true; // Mark done
            }
            // Save to browser
            localStorage.setItem('paperMonster_doneShots', JSON.stringify(doneShots));
            updateSelectorAndStatus();
        }

        function jumpToShot(val) {
            currentIndex = parseInt(val);
            render();
        }

        // --- TOUCH / SWIPE ---
        let touchStartX = 0;
        let touchEndX = 0;
        const touchZone = document.getElementById('touchZone');

        touchZone.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, false);

        touchZone.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);

        function handleSwipe() {
            if (touchEndX < touchStartX - 50) {
                changeShot(1); // Swipe Left -> Next
            }
            if (touchEndX > touchStartX + 50) {
                changeShot(-1); // Swipe Right -> Prev
            }
        }

        // --- DRAWING ---
        function drawRoom() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            // Grid
            ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 1;
            for(let i=0; i<800; i+=40) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,600); ctx.stroke(); }
            for(let i=0; i<600; i+=40) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(800,i); ctx.stroke(); }

            // Fixtures
            ctx.fillStyle = '#bae6fd'; ctx.fillRect(100, 0, 400, 15); // Windows
            ctx.fillStyle = '#0284c7'; ctx.font='10px sans-serif'; ctx.fillText("WINDOWS", 300, 25);
            
            ctx.fillStyle = '#22c55e'; ctx.fillRect(360, 580, 80, 20); // Door
            ctx.fillStyle = '#14532d'; ctx.fillText("DOOR", 400, 575);

            ctx.fillStyle = '#334155'; ctx.fillRect(760, 150, 15, 300); // Board
            ctx.save(); ctx.translate(750, 300); ctx.rotate(-Math.PI/2); 
            ctx.fillStyle = '#64748b'; ctx.fillText("BOARD", 0, 0); ctx.restore();

            ctx.fillStyle = '#d8b4fe'; ctx.fillRect(650, 50, 100, 60); // Desk
            ctx.fillStyle = '#581c87'; ctx.fillText("TEACHER", 700, 85);
            
            // Hallway / Closet Areas
            ctx.fillStyle = '#fca5a5'; ctx.fillRect(350, 610, 100, 50); ctx.fillStyle='#991b1b'; ctx.fillText("HALLWAY", 400, 640);
            ctx.fillStyle = '#fca5a5'; ctx.fillRect(50, 480, 100, 80); ctx.fillStyle='#991b1b'; ctx.fillText("CLOSET", 100, 520);
        }

        function drawStudents(state, highlightId) {
            // Draw Teacher if entering
            if (state === "teacher_enter") {
                ctx.beginPath(); ctx.arc(400, 560, 20, 0, Math.PI*2);
                ctx.fillStyle = '#a855f7'; ctx.fill(); // Purple Teacher
                ctx.fillStyle = '#fff'; ctx.textAlign='center'; ctx.fillText("Teacher", 400, 595);
            }

            Object.keys(seats).forEach(key => {
                const s = seats[key];
                let x = s.x; let y = s.y;
                let color = '#60a5fa'; // Blue
                let label = s.name;
                let isStanding = false;
                let isHiding = false;

                // State Logic
                if (state === 'bejna_stands' || state === 'bejna_pacing') {
                    if (key === 'bejna') { x -= 30; color = '#f59e0b'; label += " (Stand)"; isStanding = true; }
                    if (state === 'bejna_pacing' && key === 'bejna') { x -= 20; label = "Pacing..."; }
                }
                if (key === 'siyajin' && state === 'siyajin_jumps') { color = '#ef4444'; label += " (JUMP)"; isStanding = true; }
                if (state === 'group_huddle') { if(!isStanding) { x = (x + 340)/2; y = (y + 300)/2; } }
                if (state === 'scare_jump') { x -= 20; color = '#f87171'; label += " (Scare)"; } // Recoil Left
                if (state === 'rizgar_hiding' && key === 'rizgar') { isHiding = true; color = '#94a3b8'; label += " (Hidden)"; }
                if (state === 'group_slump') { color = '#93c5fd'; y += 5; } // Slump

                // Desk
                ctx.fillStyle = '#cbd5e1'; ctx.fillRect(x+10, y-20, 30, 40);

                // Body
                if (isHiding) {
                     ctx.beginPath(); ctx.arc(x, y, 15, 0, Math.PI*2); ctx.fillStyle = color; ctx.fill();
                     ctx.fillStyle = 'rgba(203, 213, 225, 0.8)'; ctx.fillRect(x+10, y-20, 30, 40); // Desk opaque
                } else {
                    ctx.beginPath(); ctx.arc(x, y, 18, 0, Math.PI*2); ctx.fillStyle = color; ctx.fill();
                    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+18, y); ctx.stroke();
                }

                if (key === highlightId) { ctx.strokeStyle = '#facc15'; ctx.lineWidth = 4; ctx.stroke(); }
                ctx.fillStyle = '#0f172a'; ctx.font='10px sans-serif'; ctx.textAlign='center'; 
                ctx.fillText(label, x, y+28);
            });
        }

        function drawCamera(cam, move) {
            if(!cam) return;
            if (move) {
                ctx.strokeStyle = '#ec4899'; ctx.setLineDash([5,5]);
                if (move.type === 'pan') {
                    ctx.beginPath(); ctx.arc(cam.x, cam.y, 50, move.angles[0]*Math.PI/180, move.angles[1]*Math.PI/180); ctx.stroke();
                } else {
                    ctx.beginPath(); ctx.moveTo(move.startX, move.startY); ctx.lineTo(move.endX, move.endY); ctx.stroke();
                    ctx.beginPath(); ctx.arc(move.endX, move.endY, 3, 0, Math.PI*2); ctx.fillStyle='#ec4899'; ctx.fill();
                }
                ctx.setLineDash([]);
            }
            ctx.save(); ctx.translate(cam.x, cam.y); ctx.rotate(cam.angle * Math.PI/180);
            ctx.fillStyle = 'rgba(236, 72, 153, 0.2)'; ctx.beginPath(); ctx.moveTo(0,0);
            ctx.lineTo(500 * Math.cos(-cam.fov*Math.PI/360), 500 * Math.sin(-cam.fov*Math.PI/360));
            ctx.lineTo(500 * Math.cos(cam.fov*Math.PI/360), 500 * Math.sin(cam.fov*Math.PI/360)); ctx.fill();
            ctx.fillStyle = '#be185d'; ctx.beginPath(); ctx.moveTo(-8,-8); ctx.lineTo(12,0); ctx.lineTo(-8,8); ctx.fill();
            ctx.restore();
        }

        function render() {
            const s = shots[currentIndex];
            document.getElementById('shotCode').innerText = s.code;
            document.getElementById('shotTitle').innerText = s.title;
            document.getElementById('shotLens').innerText = s.lens;
            document.getElementById('shotType').innerText = s.type;
            document.getElementById('shotAction').innerText = s.action;
            document.getElementById('shotDialogue').innerText = s.dialogue;
            
            updateSelectorAndStatus();
            drawRoom();
            drawStudents(s.layoutState, s.highlight);
            drawCamera(s.cam, s.move);
        }

        function changeShot(d) {
            currentIndex += d;
            if(currentIndex < 0) currentIndex = 0;
            if(currentIndex >= shots.length) currentIndex = shots.length - 1;
            render();
        }

        window.addEventListener('keydown', e => {
            if(e.key === "ArrowRight") changeShot(1);
            if(e.key === "ArrowLeft") changeShot(-1);
        });
        
        // Initial Render
        render();

    </script>
</body>
</html>
